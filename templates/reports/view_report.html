{% extends 'reports/base.html' %}

{% load bootstrap3 %}

{% block title %}reports view{% endblock %}

{% block content %}

<h1>reports view</h1>

<section>
  <h2>Filters</h2>

  <form action="{% url 'reports:view_report' %}" method="get" class="form-horizontal">
    {% comment %}
    <!-- This gets in the way of saving queries by GET URI. -->
    <!-- csrf vulnerability: Cross-site DoS by spamming queries. -->
    <!-- Probably not a serious concern. -->
    {% csrf_token %}
    {% endcomment %}
    {% bootstrap_form form %}
    <div id="fields">
    </div>
    {% buttons submit='Regenerate' reset='Reset' %}
    {% endbuttons %}
  </form>

  <script>


   /* JQuery deparam function

      https://github.com/chrissrogers/jquery-deparam/blob/master/jquery-deparam.min.js
    */
   (function(h){h.deparam=function(i,j){var d={},k={"true":!0,"false":!1,"null":null};h.each(i.replace(/\+/g," ").split("&"),function(i,l){var m;var a=l.split("="),c=decodeURIComponent(a[0]),g=d,f=0,b=c.split("]["),e=b.length-1;/\[/.test(b[0])&&/\]$/.test(b[e])?(b[e]=b[e].replace(/\]$/,""),b=b.shift().split("[").concat(b),e=b.length-1):e=0;if(2===a.length)if(a=decodeURIComponent(a[1]),j&&(a=a&&!isNaN(a)?+a:"undefined"===a?void 0:void 0!==k[a]?k[a]:a),e)for(;f<=e;f++)c=""===b[f]?g.length:b[f],m=g[c]=
f<e?g[c]||(b[f+1]&&isNaN(b[f+1])?{}:[]):a,g=m;else h.isArray(d[c])?d[c].push(a):d[c]=void 0!==d[c]?[d[c],a]:a;else c&&(d[c]=j?void 0:"")});return d}})(jQuery);


   (function(){

     var template_prefix = 'template_'
     var div_prefix = 'div_template_'
     var last = null;
     var cached = [];

     function load_template_handler(data) {
       /* console.dir(data); */

       /* Make a new form input.
        */

       var template_id = data['id'];
       var template_name = data['name']
       var input_id = template_prefix + template_id.toString();
       // Create new form input.
       var input_div = $('<div/>', {
         class: 'form-group has-success',
         id: div_prefix + template_id,
       });
       var label = $('<label/>', {
         class: 'control-label',
         for: template_id,
       });
       label.append(document.createTextNode(template_name));
       label.appendTo(input_div);
       var select = $('<select/>', {
         multiple: 'multiple',
         class: 'form-control',
         id: input_id,
         name: input_id,
         title: '',
       });
       select.appendTo(input_div);

       // Add field options.
       data['fields'].forEach(function(row){
         var id = row[0];
         var name = row[1];
         var option = $('<option/>', {
           value: id,
         });
         option.append(document.createTextNode(name));
         option.appendTo(select);
       });

       input_div.appendTo('#fields');
       cached.push(template_id);
     }

     /* template_id is a string */
     function load_template(template_id) {
       $.get(location.origin +
             "{% url 'reports:template_fields' %}?id=" +
             template_id,
             load_template_handler);
     }

     $('#id_templates').change(function(e) {
       /* On template selection change,

          We load selected templates.  For new templates, we query for the
          template's fields and make an input form.  If we already have an input
          form for it, we show it.
        */

       var selected = $(e.target).val();

       selected.forEach(function(template_id){
         if (cached.indexOf(parseInt(template_id)) === -1) {
           // Some browsers don't support location.origin
           if (typeof location.origin === 'undefined') {
             location.origin = location.protocol + '//' + location.host
           };

           load_template(template_id);
         } else {
           // Unhide form.
           $('#' + template_prefix + template_id).attr(
             'name', template_prefix + template_id);
           $('#' + div_prefix + template_id).show();
         }
       });

       // Hide unselected forms.
       if (last !== null) {
         last.forEach(function(template_id){
           if (selected.indexOf(template_id) === -1) {
             $('#' + template_prefix + template_id).removeAttr('name');
             $('#' + div_prefix + template_id).hide();
           }
         });
       }
       last = selected;
     });

     /* Generate template inputs for the templates in the GET request */
     $(document).ready(function(){
       // location.search = '?param=value&param=value...'
       var params = location.search.slice(1);
       params = $.deparam(params);
       var templates = params['templates']

       if (typeof templates === 'string') {
         templates = [templates];
       }
       templates.forEach(function(template_id){
           load_template(template_id);
       });
     });

   })();
  </script>
</section>

<section>

  <h2>Data</h2>

  <table class="table table-condensed">
    <thead>
      <tr>
        <th>Template</th>
        <th>Field</th>
        <th>Count</th>
        <th>Percentage</th>
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
      <tr>
        {% for cell in row %}
        <td>{{ cell }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

</section>

{% endblock %}
