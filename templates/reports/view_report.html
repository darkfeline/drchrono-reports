{% extends 'reports/base.html' %}

{% load bootstrap3 %}

{% block title %}reports view{% endblock %}

{% block content %}

<h1>reports view</h1>

<section>
  <h2>Filters</h2>

  <form action="{% url 'reports:view_report' %}" method="get" class="form-horizontal">
    {% comment %}
    <!-- This gets in the way of saving queries by GET URI. -->
    <!-- csrf vulnerability: Cross-site DoS by spamming queries. -->
    <!-- Probably not a serious concern. -->
    {% csrf_token %}
    {% endcomment %}
    {% bootstrap_form form %}
    {% buttons submit='Regenerate' reset='Reset' %}
    {% endbuttons %}
  </form>

  <script>
   $(function(){

     var last = null;
     var cached = [];

     function field_resp_handler(data) {
       /* console.dir(data); */
       data.forEach(function(row){
         var id = data[0];
         var name = data[1];
         if ($.inArray(id, cached)) {
           cached.push(id);
           // Load form
         } else {
           // unhide form
         }
       });

       // Hide forms
     }

     $('#id_templates').change(function(e) {
       var selected = $(e.target).val();

       // Some browsers don't support location.origin
       if (typeof location.origin === 'undefined')
         location.origin = location.protocol + '//' + location.host;


       selected.forEach(function(template){
         $.get(location.origin +
               "{% url 'reports:template_fields' %}?id=" +
               template,
               field_resp_handler);
       })
     });
   });
  </script>
</section>

<section>

  <h2>Data</h2>

  <table class="table table-condensed">
    <thead>
      <tr>
        <th>Template</th>
        <th>Field</th>
        <th>Count</th>
        <th>Percentage</th>
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
      <tr>
        {% for cell in row %}
        <td>{{ cell }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

</section>

{% endblock %}
