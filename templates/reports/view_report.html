{% extends 'reports/base.html' %}

{% load bootstrap3 %}

{% block title %}reports view{% endblock %}

{% block content %}

<h1>reports view</h1>

<section>
  <h2>Filters</h2>

  <form action="{% url 'reports:view_report' %}" method="get" class="form-horizontal">
    {% comment %}
    <!-- This gets in the way of saving queries by GET URI. -->
    <!-- csrf vulnerability: Cross-site DoS by spamming queries. -->
    <!-- Probably not a serious concern. -->
    {% csrf_token %}
    {% endcomment %}
    {% bootstrap_form form %}
    <div id="fields">
    </div>
    {% buttons submit='Regenerate' reset='Reset' %}
    {% endbuttons %}
  </form>

  <script>
   (function(){

     var template_prefix = 'template_'
     var div_prefix = 'div_template_'
     var last = null;
     var cached = [];

     function field_resp_handler(data) {
       /* console.dir(data); */

       /* Make a new form input.
        */

       var template_id = data['id'];
       var template_name = data['name']
       var input_id = template_prefix + template_id.toString();
       // Create new form input.
       var input_div = $('<div/>', {
         class: 'form-group has-success',
         id: div_prefix + template_id,
       });
       var label = $('<label/>', {
         class: 'control-label',
         for: template_id,
       });
       label.append(document.createTextNode(template_name));
       label.appendTo(input_div);
       var select = $('<select/>', {
         multiple: 'multiple',
         class: 'form-control',
         id: input_id,
         name: input_id,
         title: '',
       });
       select.appendTo(input_div);

       // Add field options.
       data['fields'].forEach(function(row){
         var id = row[0];
         var name = row[1];
         var option = $('<option/>', {
           value: id,
         });
         option.append(document.createTextNode(name));
         option.appendTo(select);
       });

       input_div.appendTo('#fields');
       cached.push(template_id);
     }

     $('#id_templates').change(function(e) {
       /* On template selection change,

          We load selected templates.  For new templates, we query for the
          template's fields and make an input form.  If we already have an input
          form for it, we show it.
        */

       var selected = $(e.target).val();

       selected.forEach(function(template_id){
         if (cached.indexOf(parseInt(template_id)) === -1) {
           // Some browsers don't support location.origin
           if (typeof location.origin === 'undefined') {
             location.origin = location.protocol + '//' + location.host
           };

           $.get(location.origin +
                 "{% url 'reports:template_fields' %}?id=" +
                 template_id,
                 field_resp_handler);
         } else {
           // Unhide form.
           $('#' + template_prefix + template_id).attr(
             'name', template_prefix + template_id);
           $('#' + div_prefix + template_id).show();
         }
       });

       // Hide unselected forms.
       if (last !== null) {
         last.forEach(function(template_id){
           if (selected.indexOf(template_id) === -1) {
             $('#' + template_prefix + template_id).removeAttr('name');
             $('#' + div_prefix + template_id).hide();
           }
         });
       }
       last = selected;
     });
   })();
  </script>
</section>

<section>

  <h2>Data</h2>

  <table class="table table-condensed">
    <thead>
      <tr>
        <th>Template</th>
        <th>Field</th>
        <th>Count</th>
        <th>Percentage</th>
      </tr>
    </thead>
    <tbody>
      {% for row in data %}
      <tr>
        {% for cell in row %}
        <td>{{ cell }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

</section>

{% endblock %}
